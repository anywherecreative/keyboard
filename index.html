<!doctype HTML>
<html>
<head>
    <title>
        Sounds
    </title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/js/all.min.js" integrity="sha512-YSdqvJoZr83hj76AIVdOcvLWYMWzy6sJyIMic2aQz5kh2bPTd9dzY3NtdeEAzPp/PhgZqr4aJObB3ym/vsItMg==" crossorigin="anonymous"></script>
</head>
<body>
<h1>Sounds!</h1>

<button data-tone="a">A</button>
<button data-tone="b">B</button>
<button data-tone="c">C</button>
<button data-tone="d">D</button>
<button data-tone="e">E</button>
<button data-tone="f">F</button>
<button data-tone="g">G</button>

<label>
    <input type="checkbox" id="keyboard"> Play with Keyboard
</label>

<label>
    <button id="record">Record</button>
</label>

<label>
    <button id="play" disabled><i class="far fa-play-circle"></i> Play</button>
</label>

<label>
    <button id="save">Save</button>
</label>

<h2>Your Songs</h2>

<ul id="library">

</ul>

<script
        src="http://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
        crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>

<script>
    var recording = [];
    var isRecording = false;
    var recordingOffset = null;
    var playback = false;
    var position = 0;
    var library = [];

    function play(tone) {
        var audio = new Audio('wav/'+tone+'.wav');
        audio.play();

        if(isRecording) {
            recording.push({
                offset: new Date() - recordingOffset,
                tone: tone
            });
            recordingOffset = + new Date();
        }
    }

    $(document).ready(function() {
        if (typeof(Storage) !== "undefined") {
            if(localStorage.getItem("library") !== null) {
                library = JSON.parse(localStorage.getItem("library"));
            }
        }
        $.each(library,function(key,value) {
            $('#library').append('<li data-id="' + key + '">' + value.title + ' <button class="btn btn-link btn-sm p-1 play"><i class="far fa-play-circle fa-2x"></i></button> <button class="btn btn-link btn-sm p-1 loop"><i class="fas fa-redo"></i></button></li>');
        });

        $('[data-tone]').mousedown(function() {
            play($(this).data('tone'));
        })
        $('#library').on('click','.play',function() {
            var song = $(this).parent().data('id');
            $("[data-id='"+song+"']").data('play',true);
            $("[data-id='"+song+"']").data('loop',false);
            $("[data-id='"+song+"']").data('position',0);
            nextNote(song)
        })

        $('#library').on('click','.loop',function() {
            var song = $(this).parent().data('id');
            if($("[data-id='"+song+"']").data('loop')) {
                $("[data-id='"+song+"']").data('play',false);
                $("[data-id='"+song+"']").data('loop',false);
                $("[data-id='"+song+"']").data('position',0);
            }
            else {
                $("[data-id='"+song+"']").data('play',true);
                $("[data-id='"+song+"']").data('loop',true);
                $("[data-id='"+song+"']").data('position',0);
                nextNote(song)
            }
        })
    })

    $(document).keydown(function(e){
        if($('#keyboard').is(':checked')) {
            var validKeys = ['a','b','c','d','e','f','g'];
            if(validKeys.includes(e.key)) {
                play(e.key);
            }
        }
    });

    $('#record').click(function() {
        if(isRecording) {
            recordingOffset = null;
            isRecording = false;
            $(this).text('Record');
            $('#play').removeAttr('disabled');
        }
        else {
            recordingOffset = + new Date();
            isRecording = true;
            $(this).text('Stop');
        }
    })

    $('#play').click(function() {
        if(playback) {
            $(this).text('Play');
            playback = false;
        }
        else {
            $(this).text('Stop');
            playback = true;
            setTimeout(function() {replay()}, recording[position].offset);
        }
    });

    function replay() {
        if(playback) {
            play(recording[position].tone);
            position++;

            if(recording.length == position) {
                playback = false;
                position = 0;
                $('#play').text('Play');
            }
            else {
                setTimeout(function() {replay()}, recording[position].offset);
            }
        }
    }

    $('#save').click(function() {
        var title = prompt('Enter a title for your tune!',"");
        library.push({
            title: title,
            recording: recording
        });
        if (typeof(Storage) !== "undefined") {
            localStorage.setItem("library", JSON.stringify(library));
        }
    });


    function nextNote(song) {
        if($("[data-id='"+song+"']").data('play')) {
            var pos = $("[data-id='"+song+"']").data('position');
            play(library[song].recording[pos].tone);
            pos++;
            $("[data-id='"+song+"']").data('position',pos);
            if(library[song].recording.length == pos) {
                if(!$("[data-id='"+song+"']").data('loop')) {
                    $("[data-id='"+song+"']").data('play',false);
                    $("[data-id='"+song+"']").data('position',0);
                }
                else {
                    $("[data-id='"+song+"']").data('position',0);
                    setTimeout(function() {nextNote(song)}, library[song].recording[0].offset);
                }
            }
            else {
                setTimeout(function() {nextNote(song)}, library[song].recording[pos].offset);
            }
        }
    }
</script>
</body>
</html>